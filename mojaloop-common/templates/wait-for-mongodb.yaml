{{/*
  Mojaloop Common template for MongoDB wait-for-mongodb initContainer as a full resource
  Usage: {{- include "mojaloop-common.waitForMongodbInitContainer" . | nindent 2 }}
*/}}
{{- define "mojaloop-common.waitForMongodbInitContainer" -}}
- name: wait-for-mongodb
  image: bitnamilegacy/mongodb:6.0.1
  imagePullPolicy: IfNotPresent
  command:
    - sh
    - -c
    - |
      retries=0;
      max_retries=10;
      until [ $retries -eq $max_retries ] || mongosh mongodb://${DB_HOST}:${DB_PORT} --authenticationDatabase "${DB_DATABASE}" --username "${DB_USER}" --password "${DB_PASS}" --eval "disableTelemetry();db.adminCommand('ping')" ;
      do
        echo --------------------;
        echo Waiting for MongoDB...;
        retries=$((retries+1));
        echo "Retry $retries of $max_retries";
        sleep 2;
      done;
      echo ====================;
      echo MongoDB ok!;
  env:
    - name: DB_HOST
      value: '{{ .Values.config.mongo_host }}'
    - name: DB_PORT
      value: '{{ .Values.config.mongo_port }}'
    - name: DB_USER
      value: '{{ .Values.config.mongo_user }}'
    - name: DB_PASS
      {{- if .Values.config.mongo_secret }}
      valueFrom:
          secretKeyRef:
            name: '{{ .Values.config.mongo_secret.name }}'
            key: '{{ .Values.config.mongo_secret.key }}'
      {{- else }}
      value: {{ .Values.config.mongo_password }}
      {{- end }}
    - name: DB_DATABASE
      value: '{{ .Values.config.mongo_database }}'
{{- end }}
