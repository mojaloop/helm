{{- $prefix := printf "%s-" $.Release.Name }}
{{- range $name, $customConfig := .Values.simulators }}
{{- $config := merge $customConfig $.Values.defaults }}
apiVersion: v1
kind: Service
metadata:
  name: {{ $prefix }}{{ $name }}-backend
  labels:
    app: {{ $prefix }}{{ $name }}-backend
    chart: {{ template "mojaloop-simulator.chart" $ }}
    release: {{ $.Release.Name }}
    heritage: {{ $.Release.Service }}
spec:
   type: ClusterIP
   ports:
     - port: 3000
       protocol: TCP
       name: simapi
       targetPort: simapi
     - port: 3002
       protocol: TCP
       name: reportapi
       targetPort: reportapi
     - port: 3003
       protocol: TCP
       name: testapi
       targetPort: testapi
   selector:
     app: {{ $prefix }}{{ $name }}-backend
     release: {{ $.Release.Name }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ $prefix }}{{ $name }}-scheme-adapter
  labels:
    app: {{ $prefix }}{{ $name }}-scheme-adapter
    chart: {{ template "mojaloop-simulator.chart" $ }}
    release: {{ $.Release.Name }}
    heritage: {{ $.Release.Service }}
spec:
   type: ClusterIP
   ports:
     - port: 4000
       protocol: TCP
       name: inboundapi
       targetPort: inboundapi
     - port: 4001
       protocol: TCP
       name: outboundapi
       targetPort: outboundapi
   selector:
     app: {{ $prefix }}{{ $name }}-scheme-adapter
     release: {{ $.Release.Name }}
---
{{- if $config.config.cache.enabled }}
apiVersion: v1
kind: Service
metadata:
  name: {{ $prefix }}{{ $name }}-cache
  labels:
    app: {{ $prefix }}{{ $name }}-cache
    chart: {{ template "mojaloop-simulator.chart" $ }}
    release: {{ $.Release.Name }}
    heritage: {{ $.Release.Service }}
spec:
   type: ClusterIP
   ports:
     - port: 6379
       protocol: TCP
       name: redis
       targetPort: redis
   selector:
     app: {{ $prefix }}{{ $name }}-cache
     release: {{ $.Release.Name }}
{{- end }}
---
{{ end }}
